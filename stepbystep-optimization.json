{"version":3,"kind":"Notebook","sha256":"0de753b1128df0240ac565f3f03d376f8ddd38374e37bc4b5a931f1e3cf05200","slug":"stepbystep-optimization","location":"/optimization/ressources/StepByStep_Optimization.ipynb","dependencies":[],"frontmatter":{"title":"Step by step Optimization : understanding gradient based method","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"IR_env","language":"python"},"github":"https://github.com/symmeHub/positron","numbering":{"title":{"offset":2}},"source_url":"https://github.com/symmeHub/positron/blob/main/book/optimization/ressources/StepByStep_Optimization.ipynb","edit_url":"https://github.com/symmeHub/positron/edit/main/book/optimization/ressources/StepByStep_Optimization.ipynb","exports":[{"format":"ipynb","filename":"StepByStep_Optimization.ipynb","url":"/armageddon/build/StepByStep_Optimizat-4ce53d683f9e8746e3bf1b0222c67c26.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%matplotlib widget\n# %matplotlib widget\nimport matplotlib.pyplot as plt\nimport numpy as np\nfrom scipy import optimize\nimport ipywidgets as ipw\nfrom matplotlib import cm\nimport ipywidgets as widgets","key":"N10ddGVns1"},{"type":"outputs","id":"nIUmhfm0z_f2Pp8QJQ3X4","children":[],"key":"VMXuF3V6Fv"}],"key":"YDV42zmurs"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Cost functions","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jSDOX3IsKc"}],"identifier":"cost-functions","label":"Cost functions","html_id":"cost-functions","implicit":true,"key":"vdQ69NB5Zb"}],"key":"V62aQ8aS0K"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Goldstein–Price function","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hyZeglGIix"}],"identifier":"goldstein-price-function","label":"Goldstein–Price function","html_id":"goldstein-price-function","implicit":true,"key":"w0UFAxMq03"}],"key":"ux3NqHuviM"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def cost(p):\n    global counterCostCall\n    \"\"\"\n    Goldstein–Price.\n    https://en.wikipedia.org/wiki/Test_functions_for_optimization    \"\"\"\n\n    x, y = p\n    f = (\n        1\n        + (\n            (x + y + 1) ** 2\n            * (19 - 14 * x + 3 * x**2 - 14 * y + 6 * x * y + 3 * y**2)\n        )\n    ) * (\n        30\n        + (2 * x - 3 * y) ** 2\n        * (18 - 32 * x + 12 * x**2 + 48 * y - 36 * x * y + 27 * y**2)\n    )\n    return f / 80000.0\n\n\ncounterCostCall = 0\nNx, Ny = 100, 100\nx = np.linspace(-1.5, 1.5, Nx)\ny = np.linspace(-1.5, 1.5, Ny)\nX, Y = np.meshgrid(x, y)\nzf = np.array([X.flatten(), Y.flatten()])\nZ = cost(zf).reshape(Nx, Ny)\nZ = np.where(Z > 0.3, np.nan, Z)\nmask = np.ones_like(Z)","key":"hPbQBo1oul"},{"type":"outputs","id":"DdHdJYkoEohBEEJD6Jk2k","children":[],"key":"p8kUAGjC7m"}],"key":"BXTQgkQxZv"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Himmelblau cost function","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SVfVyFGnQV"}],"identifier":"himmelblau-cost-function","label":"Himmelblau cost function","html_id":"himmelblau-cost-function","implicit":true,"key":"u1VdzQBrcm"}],"key":"YwqdX8TxfV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def cost(p):\n    global counterCostCall\n    \"\"\"\n    Himmelblau cost function.\n    https://en.wikipedia.org/wiki/Himmelblau%27s_function\n    \"\"\"\n\n    x, y = p\n    return (x**2 + y - 11) ** 2 + (x + y**2 - 7) ** 2\n\n\ncounterCostCall = 0\nNx, Ny = 100, 100\nx = np.linspace(-5.0, 5.0, Nx)\ny = np.linspace(-5.0, 5.0, Ny)\nX, Y = np.meshgrid(x, y)\nzf = np.array([X.flatten(), Y.flatten()])\nZ = cost(zf).reshape(Nx, Ny)\nZ = np.where(Z > 200.0, np.nan, Z)\n\nmask = np.ones_like(Z)","key":"qic8d9qR6k"},{"type":"outputs","id":"lCX7oQr3q75KWmTGBXS6g","children":[],"key":"vZoPMIXnBa"}],"key":"Tzp6u12Amf"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"P = np.zeros((1000, 2)) * np.nan\nV_down_hill_dir = np.zeros((1000, 2)) * np.nan\n\n\nP[0] = 3.0, -0.0\n\n\ndef maj_mask_all(mask, Pis):\n    for Pi in Pis:\n        if ~np.isnan(Pi[0]):\n            mask = maj_mask(mask, Pi)\n    return mask\n\n\ndef maj_mask(mask, Pi):\n    R = 0.5\n    mask[np.sqrt((X - Pi[0]) ** 2 + (Y - Pi[1]) ** 2) < R] = np.nan\n    return mask\n\n\nmask = maj_mask(mask, P[0])\n\n\ndef init(px=0.0, py=-4.0):\n    global mask, P, V_down_hill_dir\n    mask = np.ones_like(Z)\n    P = np.zeros((1000, 2)) * np.nan\n    V_down_hill_dir = np.zeros((1000, 2)) * np.nan\n    P[0] = px, py","key":"DuxxcyRGIG"},{"type":"outputs","id":"ImZukD0z6ur-wFJfCvCoj","children":[],"key":"ilwb44fayJ"}],"key":"OSJ6V2YX2L"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Gradiant based methode","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BAGQxrO4Ex"}],"identifier":"gradiant-based-methode","label":"Gradiant based methode","html_id":"gradiant-based-methode","implicit":true,"key":"zkQPvQRnyv"}],"key":"fwyCeRhFov"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Down hill methode","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ScRBYcjvCa"}],"identifier":"down-hill-methode","label":"Down hill methode","html_id":"down-hill-methode","implicit":true,"key":"scEPtE4kgT"}],"key":"Q9dI0ArWYY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def grad_P(Pi):\n    # Gradient computation using finite difference approach\n    eps = 0.001\n    Pdx = Pi.copy()\n    Pdx[0] = Pdx[0] + eps\n    gradx = (cost(Pdx) - cost(Pi)) / eps\n\n    Pdy = Pi.copy()\n    Pdy[1] = Pdy[1] + eps\n    grady = (cost(Pdy) - cost(Pi)) / eps\n    return np.array([gradx, grady])\n\n\ndef optim_grad():\n    global counter, P, V_down_hill_dir\n    # compute gradient at curent point\n    g = grad_P(P[counter])\n    g_normalized = g / np.linalg.norm(g)\n    # compute down hill direction\n    down_hill_dir = -g_normalized\n    V_down_hill_dir[counter] = down_hill_dir\n    step = 0.1\n    # compute next point with a constante step in down hill dir\n    P[counter + 1] = P[counter] + step * down_hill_dir\n    counter += 1","key":"ZrxLN3kBkx"},{"type":"outputs","id":"f6vxQK0Y3JSNzH7bqillF","children":[],"key":"mq64GW4F79"}],"key":"NQ088gKTWk"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Down hill methode with linear search","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UE30x8qfG7"}],"identifier":"down-hill-methode-with-linear-search","label":"Down hill methode with linear search","html_id":"down-hill-methode-with-linear-search","implicit":true,"key":"VifjJRC8jJ"}],"key":"rzVseReCB1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def optim_grad_lin_search():\n    global counter, P, V_down_hill_dir\n    # compute gradient at curent point\n    g = grad_P(P[counter])\n    g_normalized = g / np.linalg.norm(g)\n    # compute down hill direction\n    down_hill_dir = -g_normalized\n    V_down_hill_dir[counter] = down_hill_dir\n    step = 0.1\n    go = True\n    while go:\n        P_new = P[counter] + step * down_hill_dir\n        if cost(P_new) > cost(P[counter]):\n            go = False\n        else:\n            P[counter + 1] = P_new\n            counter += 1","key":"mIoIM8xg9N"},{"type":"outputs","id":"XET-05rS0jAueab3xT70p","children":[],"key":"rAwHQMsMmY"}],"key":"Wfn0CbPWaM"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"init(px=-0.32, py=-0.62)\nalpha = 0.7\nmask = maj_mask_all(mask, P)\n\nplt.figure(figsize=(6, 4))\ntitle = plt.title(\"\")\ncost_map = plt.contourf(X, Y, np.log(Z), 100, cmap=cm.jet)\nplt.colorbar(cost_map)\nplt.contour(X, Y, np.log(Z), 500, cmap=cm.gray, zorder=2.0, linewidths=0.2)\nplt.contour(X, Y, np.log(Z), 50, cmap=cm.gray, zorder=2.0, linewidths=0.5)\n(line,) = plt.plot(P[:, 0], P[:, 1], \".g\", label=\"Path\")\n(line0,) = plt.plot(P[:1, 0], P[:1, 1], \"r\", label=\"Start\")\n\n\nv = plt.quiver(\n    P[:, 0],\n    P[:, 1],\n    V_down_hill_dir[:, 0],\n    V_down_hill_dir[:, 1],\n    scale=10,\n    zorder=2.4,\n    width=0.005,\n    label=\"DownHill Dir\",\n    angles=\"xy\",\n)\np = [plt.contourf(X, Y, mask, 2, cmap=cm.gray, zorder=2.3, alpha=alpha)]\n\nplt.legend()\nplt.tight_layout()\n# get ax object\nax = plt.gca()\n\ncounter = 0\n\n\n@ipw.interact_manual()\ndef run_step():\n    global P, counter, mask, v, V_down_hill_dir\n\n    # optim_grad()\n    optim_grad_lin_search()\n\n    mask = maj_mask_all(mask, P)\n\n    for tp in p[0].collections:\n        tp.remove()\n    v.remove()\n\n    p[0] = plt.contourf(X, Y, mask, 2, cmap=cm.gray, zorder=2.3, alpha=alpha)\n    v = plt.quiver(\n        P[:, 0],\n        P[:, 1],\n        V_down_hill_dir[:, 0],\n        V_down_hill_dir[:, 1],\n        scale=10,\n        zorder=2.4,\n        width=0.005,\n        label=\"DownHill Dir\",\n        angles=\"xy\",\n    )\n    line.set_xdata(P[:, 0])\n    line.set_ydata(P[:, 1])\n    re = 1.0\n    # get last point which is not nan\n    last_P = P[np.where(~np.isnan(P[:, 0]))][-1]\n    # ax.set_xlim([last_P[0] - re, last_P[0] + re])\n    # ax.set_ylim([last_P[1] - re, last_P[1] + re])\n\n    # CostOverIt.set_ydata(cost(P.T))","key":"CG7OnxmOpl"},{"type":"outputs","id":"LLwbyzjkTKzf0kuFcU6xp","children":[{"type":"output","children":[],"jupyter_data":{"output_type":"display_data","metadata":{},"data":{"text/plain":{"content":"interactive(children=(Button(description='Run Interact', style=ButtonStyle()), Output()), _dom_classes=('widge…","content_type":"text/plain"},"application/vnd.jupyter.widget-view+json":{"content":"{\"version_major\":2,\"version_minor\":0,\"model_id\":\"6acdf4c603d84808b24376deab75c0e6\"}","content_type":"application/vnd.jupyter.widget-view+json"}}},"key":"fMoaZNhr3N"},{"type":"output","children":[],"jupyter_data":{"output_type":"display_data","metadata":{},"data":{"text/plain":{"content":"Canvas(toolbar=Toolbar(toolitems=[('Home', 'Reset original view', 'home', 'home'), ('Back', 'Back to previous …","content_type":"text/plain"},"image/png":{"content_type":"image/png","hash":"63ab9355f42890963eaa1d5c3506ad93","path":"/armageddon/build/63ab9355f42890963eaa1d5c3506ad93.png"},"text/html":{"content_type":"text/html","hash":"29eb07f79c26972a3800d1d59ddc7bf4","path":"/armageddon/build/29eb07f79c26972a3800d1d59ddc7bf4.html"},"application/vnd.jupyter.widget-view+json":{"content":"{\"version_major\":2,\"version_minor\":0,\"model_id\":\"d532b423490e45418480ee00856b3153\"}","content_type":"application/vnd.jupyter.widget-view+json"}}},"key":"iFNKbNLBU6"}],"key":"E5vMX94VUU"}],"key":"jRQCpAP5KS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"","key":"RQNRc1fF1P"},{"type":"outputs","id":"pFBCgonPQ2n3ffwkkP0Wc","children":[],"key":"DC4XptiBcW"}],"key":"INbowtvWlE"}],"key":"lb2cZL3cGI"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Illustration : Crossing a river","url":"/river-crossing-and-more","group":"Optimization"},"next":{"title":"Exercices","url":"/exercises-4","group":"Optimization"}}},"domain":"http://localhost:3002"}